<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Smart Hatch</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <h2>Ввод данных о новом люке:</h2>
    <form name="hatchForm">
      <div>
        <label for="number">Номер люка:</label>
        <input type="number" id="number" name="id" />
        <!--можно дописать required, чтобы форма не отправлялась если этих данных нет -->
      </div>
      <div>
        <label for="nameOrg">Наименование организации:</label>
        <select id="organization" name="organization">
          <option disabled selected>Выберите организацию:</option>
        </select>
      </div>
      <div>
        <div class="div1"><label for="coords">Координаты:</label></div>
        <div class="div1">
          <!-- <label class="lbl" for="coordX">X:</label> -->
          <input type="text" id="coordX" name="coordX" placeholder="X" />
        </div>
        <div class="div1">
          <!-- <label class="lbl" for="coordY">Y:</label> -->
          <input type="text" id="coordY" name="coordY" placeholder="Y" />
        </div>
        <div class="div1">
          <button class="map" , type="button">Карта</button>
        </div>
      </div>
      <div>
        <label for="state">Состояние датчика:</label>
        <input type="number" id="state" name="state" />
      </div>
      <div>
        <label for="dateTo">Дата последнего ТО:</label>
        <input type="date" id="dateTo" name="dateTo" />
      </div>
      <div>
        <label for="dateLastWork">Дата последнего срабатывания датчика:</label>
        <input type="date" id="dateLastWork" name="dateLastWork" />
      </div>
      <div class="buttons">
        <button id="btn-submit" type="submit">Отправить</button>
      </div>
    </form>
  </body>

  <script>
    // Добавление пользователя
    //Создаем асинхронную функцию
    async function createOrg(hatch) {
      //асинхронная операция, приостанавливает выполнение функции,пока не вернется результат. fetch(параметры ресурса, куда функция обращается, доп.настройки запроса) -
      //возвращает объект Promise,который получает ответ после завершения запроса к сетевому ресурсу
      const response = await fetch("http://127.0.0.1:5501/org", {
        //метод запроса
        method: "POST",
        //набор заголовков ответа
        headers: {
          //клиент принимает данные в формате json
          Accept: "application/json",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        //содержимое ответа, данные которые добавляются в запрос
        body: new URLSearchParams({
          id: hatch.id,
          orgId: hatch.orgId,
          coordX: hatch.coordX,
          coordY: hatch.coordY,
          state: hatch.state,
          dateTo: hatch.dateTo,
          dateLastWork: hatch.dateLastWork,
        }),
      });
    }

    async function getOrg() {
      const response = await fetch("http://127.0.0.1:5501/org", {
        method: "GET",
        headers: { Accept: "application/json" },
      });
      if (response.ok === true) {
        const orgs = await response.json();
        let orgSelect = document.querySelector("[id='organization']");
        orgs.forEach((org) => {
          let option = document.createElement("option");
          option.value = org.id;
          option.textContent = org.name;

          orgSelect.appendChild(option);
        });
      }
    }

    // отправка формы
    // Свойство навигации по формам
    document.forms["hatchForm"].addEventListener("submit", (event) => {
      //отмена стандарного действия браузера
      event.preventDefault();
      //Элементы формы
      let hatch = {};
      const form = document.forms["hatchForm"];
      hatch.id = form.elements["id"].value;

      var sel = document.getElementById("organization");
      hatch.orgId = sel.options[sel.selectedIndex].value;

      hatch.coordX = form.elements["coordX"].value;
      hatch.coordY = form.elements["coordY"].value;
      hatch.state = form.elements["state"].value;
      hatch.dateTo = form.elements["dateTo"].value;
      hatch.dateLastWork = form.elements["dateLastWork"].value;

      createOrg(hatch);
    });

    document.addEventListener("DOMContentLoaded", getOrg, false);
  </script>
</html>
